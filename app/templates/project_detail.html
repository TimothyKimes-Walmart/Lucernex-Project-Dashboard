{% extends "base.html" %}
{% set active_page = "projects" %}

{% block title %}{{ project.project_id }}{% endblock %}

{% block content %}
<!-- Back Link -->
<a href="/projects" onclick="event.preventDefault(); history.back();"
   class="inline-flex items-center text-walmart-blue-100 hover:underline mb-6 text-sm"
   aria-label="Back to all projects">
  ‚Üê Back to Projects
</a>

<!-- Header -->
<div class="bg-white rounded-xl shadow-sm border border-walmart-gray-50 p-6 mb-6">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-bold">{{ project.project_id }}</h1>
      <p class="text-walmart-gray-100 mt-1">{{ project.project_type }}</p>
    </div>
    <div class="mt-2 sm:mt-0 flex items-center gap-3">
      <button type="button" id="refresh-btn" onclick="refreshData()"
              class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium
                     border border-walmart-blue-100 text-walmart-blue-100
                     hover:bg-walmart-blue-100 hover:text-white transition-colors
                     focus:outline-none focus:ring-2 focus:ring-walmart-blue-100 focus:ring-offset-2
                     disabled:opacity-50 disabled:cursor-not-allowed"
              aria-label="Refresh data from Lucernex">
        <svg id="refresh-icon" class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        <span id="refresh-label">Refresh Data</span>
      </button>
      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
        {% if project.project_status == 'Active' %}bg-walmart-green-10 text-walmart-green-100
        {% elif project.project_status == 'Complete' %}bg-walmart-blue-10 text-walmart-blue-100
        {% elif project.project_status == 'On Hold' %}bg-walmart-spark-10 text-walmart-spark-140
        {% else %}bg-walmart-red-10 text-walmart-red-100{% endif %}">
        {{ project.project_status }}
      </span>
    </div>
  </div>
</div>

<!-- Data Freshness -->
{% include 'partials/refresh_info.html' %}

<!-- Info Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
  <!-- Project Details -->
  <div class="bg-white rounded-xl shadow-sm border border-walmart-gray-50 p-6">
    <h2 class="text-lg font-semibold mb-4">Project Details</h2>
    <dl class="space-y-3 text-sm">
      <div class="flex justify-between">
        <dt class="text-walmart-gray-100">Store</dt>
        <dd class="font-medium">{{ project.store }} ({{ project.store_sequence }})</dd>
      </div>
      <div class="flex justify-between">
        <dt class="text-walmart-gray-100">Location</dt>
        <dd class="font-medium">{{ project.city }}, {{ project.state }}</dd>
      </div>
      <div class="flex justify-between">
        <dt class="text-walmart-gray-100">General Contractor</dt>
        <dd class="font-medium">{{ project.general_contractor }}</dd>
      </div>
      <div class="flex justify-between">
        <dt class="text-walmart-gray-100">SAP Project</dt>
        <dd class="font-medium font-mono text-xs">{{ project.sap_project_definition }}</dd>
      </div>
      <div class="flex justify-between">
        <dt class="text-walmart-gray-100">Last Updated</dt>
        <dd class="font-medium">{{ project.lucernex_updated_at[:10] if project.lucernex_updated_at else 'N/A' }}</dd>
      </div>
      <div class="pt-2 border-t border-walmart-gray-10">
        <dt class="text-walmart-gray-100 mb-1">Scope of Work</dt>
        <dd class="font-medium">{{ project.brief_scope_of_work }}</dd>
      </div>
    </dl>
  </div>

  <!-- Budget -->
  <div class="bg-white rounded-xl shadow-sm border border-walmart-gray-50 p-6">
    <h2 class="text-lg font-semibold mb-4">SAP Budget</h2>
    {% if project.budget %}
    <div class="space-y-4">
      <div>
        <div class="flex justify-between text-sm mb-1">
          <span class="text-walmart-gray-100">Total Budget</span>
          <span class="font-bold text-lg">{{ project.budget.budget_total | currency }}</span>
        </div>
      </div>
      {% set pct_actuals = (project.budget.budget_actuals / project.budget.budget_total * 100) if project.budget.budget_total else 0 %}
      {% set pct_committed = (project.budget.budget_committed / project.budget.budget_total * 100) if project.budget.budget_total else 0 %}
      <div class="w-full bg-walmart-gray-10 rounded-full h-4 overflow-hidden flex" role="progressbar"
           aria-valuenow="{{ pct_actuals | int }}" aria-valuemin="0" aria-valuemax="100">
        <div class="bg-walmart-blue-100 h-full" style="width: {{ pct_actuals }}%" title="Actuals"></div>
        <div class="bg-walmart-spark-100 h-full" style="width: {{ pct_committed }}%" title="Committed"></div>
      </div>
      <div class="flex justify-between text-xs text-walmart-gray-100">
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-walmart-blue-100 inline-block"></span>Actuals</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-walmart-spark-100 inline-block"></span>Committed</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-walmart-gray-10 inline-block border"></span>Open</span>
      </div>
      <dl class="grid grid-cols-3 gap-4 pt-4 border-t border-walmart-gray-10 text-sm">
        <div>
          <dt class="text-walmart-gray-100 text-xs">Actuals</dt>
          <dd class="font-bold text-walmart-blue-100">{{ project.budget.budget_actuals | currency }}</dd>
        </div>
        <div>
          <dt class="text-walmart-gray-100 text-xs">Committed</dt>
          <dd class="font-bold text-walmart-spark-140">{{ project.budget.budget_committed | currency }}</dd>
        </div>
        <div>
          <dt class="text-walmart-gray-100 text-xs">Open</dt>
          <dd class="font-bold text-walmart-green-100">{{ project.budget.budget_open | currency }}</dd>
        </div>
      </dl>
    </div>
    {% else %}
    <p class="text-walmart-gray-100">No SAP budget data found.</p>
    {% endif %}
  </div>
</div>

<!-- Comments -->
{% if project.pmo_sr_pm_comments or project.cec_comments %}
<div class="bg-white rounded-xl shadow-sm border border-walmart-gray-50 p-6 mb-6">
  <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
    <svg class="w-5 h-5 text-walmart-blue-100" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zm-4 0H9v2h2V9z" clip-rule="evenodd"/>
    </svg>
    Comments
  </h2>
  <div class="space-y-4">
    {% if project.pmo_sr_pm_comments %}
    <div>
      <h3 class="text-xs font-semibold text-walmart-gray-100 uppercase tracking-wide mb-2">PMO Sr PM Comments</h3>
      <div class="bg-walmart-gray-5 rounded-lg p-4 text-sm leading-relaxed whitespace-pre-wrap break-words border border-walmart-gray-10">
        {{- project.pmo_sr_pm_comments -}}
      </div>
    </div>
    {% endif %}
    {% if project.cec_comments %}
    <div>
      <h3 class="text-xs font-semibold text-walmart-gray-100 uppercase tracking-wide mb-2">CEC Comments</h3>
      <div class="bg-walmart-gray-5 rounded-lg p-4 text-sm leading-relaxed whitespace-pre-wrap break-words border border-walmart-gray-10">
        {{- project.cec_comments -}}
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Documents -->
<div class="bg-white rounded-xl shadow-sm border border-walmart-gray-50 p-6 mb-6">
  <div class="flex items-center justify-between">
    <span class="flex items-center gap-2 text-lg font-semibold">
      <svg class="w-5 h-5 text-walmart-spark-100" fill="currentColor" viewBox="0 0 20 20">
        <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/>
      </svg>
      Documents
      <span class="px-2 py-0.5 rounded-full bg-walmart-blue-10 text-walmart-blue-100 text-xs font-medium">
        {{ doc_count }}
      </span>
    </span>
    <div class="flex items-center gap-3">
      {% if doc_last_checked %}
      <span class="text-xs text-walmart-gray-100 hidden sm:inline">Last synced: {{ doc_last_checked[:16].replace('T', ' ') }} UTC</span>
      {% endif %}
      <button
        hx-post="/projects/{{ project.project_id }}/documents/sync"
        hx-target="#docs-panel"
        hx-swap="outerHTML"
        hx-disabled-elt="this"
        class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium
               bg-walmart-blue-100 text-white hover:bg-walmart-blue-110
               focus:outline-none focus:ring-2 focus:ring-walmart-blue-100 focus:ring-offset-2
               disabled:opacity-60 disabled:cursor-wait transition-colors"
        aria-label="Sync documents from Lucernex">
        <!-- Spinning icon shown during request -->
        <svg class="w-3.5 h-3.5 htmx-indicator animate-spin" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        <!-- Static icon shown when idle -->
        <svg class="w-3.5 h-3.5 htmx-indicator-hide" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        Sync Now
      </button>
    </div>
  </div>

  {% set sync_error = sync_error|default('') %}
  {% include 'partials/documents_panel.html' %}
</div>

<!-- Purchase Orders -->
<div class="bg-white rounded-xl shadow-sm border border-walmart-gray-50 p-6">
  <h2 class="text-lg font-semibold mb-4">Purchase Orders</h2>
  {% if project.purchase_orders %}
  <div class="overflow-x-auto">
    <table class="w-full text-sm" role="table">
      <thead>
        <tr class="bg-walmart-gray-10 border-b border-walmart-gray-50">
          <th class="text-left py-3 px-3 font-semibold" scope="col">PO Number</th>
          <th class="text-left py-3 px-3 font-semibold" scope="col">Vendor</th>
          <th class="text-left py-3 px-3 font-semibold" scope="col">Status</th>
          <th class="text-right py-3 px-3 font-semibold" scope="col">PO Total</th>
          <th class="text-right py-3 px-3 font-semibold" scope="col">Invoiced</th>
          <th class="text-right py-3 px-3 font-semibold" scope="col">Remaining</th>
          <th class="text-left py-3 px-3 font-semibold" scope="col">Created</th>
        </tr>
      </thead>
      <tbody>
        {% for po in project.purchase_orders %}
        <tr class="border-b border-walmart-gray-10 hover:bg-walmart-gray-5 transition-colors">
          <td class="py-3 px-3 font-mono">{{ po.po_number }}</td>
          <td class="py-3 px-3">{{ po.vendor }}</td>
          <td class="py-3 px-3">
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
              {% if po.po_status == 'Open' %}bg-walmart-green-10 text-walmart-green-100
              {% elif po.po_status == 'Closed' %}bg-walmart-gray-10 text-walmart-gray-160
              {% else %}bg-walmart-spark-10 text-walmart-spark-140{% endif %}">
              {{ po.po_status }}
            </span>
          </td>
          <td class="py-3 px-3 text-right">{{ po.po_total | currency }}</td>
          <td class="py-3 px-3 text-right">{{ po.invoiced_to_date | currency }}</td>
          <td class="py-3 px-3 text-right font-medium
            {% if po.remaining_to_invoice > 0 %}text-walmart-spark-140{% else %}text-walmart-green-100{% endif %}">
            {{ po.remaining_to_invoice | currency }}
          </td>
          <td class="py-3 px-3">{{ po.created_date }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="text-walmart-gray-100">No purchase orders found for this project.</p>
  {% endif %}
</div>

<script>
  function refreshData() {
    var btn = document.getElementById('refresh-btn');
    var icon = document.getElementById('refresh-icon');
    var label = document.getElementById('refresh-label');
    btn.disabled = true;
    icon.classList.add('animate-spin');
    label.textContent = 'Refreshing...';

    fetch('/api/refresh', { method: 'POST' })
      .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
      .then(function(res) {
        if (res.ok) {
          label.textContent = 'Done! Reloading...';
          setTimeout(function() { window.location.reload(); }, 500);
        } else {
          label.textContent = res.data.message || 'Refresh failed';
          setTimeout(function() { label.textContent = 'Refresh Data'; btn.disabled = false; icon.classList.remove('animate-spin'); }, 3000);
        }
      })
      .catch(function(err) {
        label.textContent = 'Error: ' + err.message;
        setTimeout(function() { label.textContent = 'Refresh Data'; btn.disabled = false; icon.classList.remove('animate-spin'); }, 3000);
      });
  }
</script>
{% endblock %}
