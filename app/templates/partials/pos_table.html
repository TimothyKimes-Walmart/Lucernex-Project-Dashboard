<!-- Updated summary panel -->
<div id="po-summary" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-6"
     hx-swap-oob="innerHTML:#po-summary">
  {% include 'partials/pos_summary.html' %}
</div>

<!-- PO Table -->
<div class="bg-white rounded-xl shadow-sm border border-walmart-gray-50 overflow-hidden">
  <div class="flex items-center justify-between px-4 py-3 border-b border-walmart-gray-10">
    <span class="text-sm text-walmart-gray-100">
      Showing <span class="font-bold text-walmart-gray-160">{{ pos|length }}</span>
      of <span class="font-bold text-walmart-gray-160">{{ total }}</span> POs
      {% if total_pages > 1 %}
      &middot; Page {{ page }}/{{ total_pages }}
      {% endif %}
    </span>
  </div>

  <div class="overflow-x-auto">
    <table class="w-full text-sm" role="table">
      <thead>
        <tr class="bg-walmart-gray-10 border-b border-walmart-gray-50">
          <th class="py-3 px-2 w-8" scope="col">
            <input type="checkbox" onchange="toggleSelectAll(this)" class="rounded border-walmart-gray-50"
                   aria-label="Select all POs">
          </th>
          {% macro sort_header(col, label, align='left') %}
          <th class="text-{{ align }} py-3 px-3 font-semibold cursor-pointer select-none
                     hover:text-walmart-blue-100 transition-colors"
              scope="col" onclick="sortPOs('{{ col }}')">
            <span class="inline-flex items-center gap-1">
              {{ label }}
              {% if sort == col %}
              <svg class="w-3 h-3 text-walmart-blue-100 {% if order == 'desc' %}rotate-180{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                <path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
              </svg>
              {% endif %}
            </span>
          </th>
          {% endmacro %}
          {{ sort_header('po_number', 'PO Number') }}
          {{ sort_header('vendor', 'Vendor') }}
          {{ sort_header('store_sequence', 'Store + Seq') }}
          {{ sort_header('city', 'City') }}
          {{ sort_header('state', 'State') }}
          {{ sort_header('project_status', 'Project Status') }}
          {{ sort_header('po_status', 'PO Status') }}
          {{ sort_header('po_total', 'PO Total', 'right') }}
          {{ sort_header('invoiced_to_date', 'Invoiced', 'right') }}
          {{ sort_header('remaining_to_invoice', 'Remaining', 'right') }}
          {{ sort_header('give_back_amount', 'Give-Back', 'right') }}
          {{ sort_header('days_since_last_invoice', 'Days Aged') }}
          {{ sort_header('created_date', 'Created') }}
          <th class="py-3 px-3 text-center font-semibold" scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for po in pos %}
        {% set aging_class = '' %}
        {% if po.days_since_last_invoice and po.days_since_last_invoice >= 60 %}
          {% set aging_class = 'bg-walmart-red-10' %}
        {% elif po.days_since_last_invoice and po.days_since_last_invoice >= 30 %}
          {% set aging_class = 'bg-yellow-50' %}
        {% endif %}
        <tr class="border-b border-walmart-gray-10 hover:bg-walmart-gray-5 transition-colors {{ aging_class }}">
          <!-- Checkbox -->
          <td class="py-3 px-2">
            <input type="checkbox" class="po-checkbox rounded border-walmart-gray-50" value="{{ po.po_number }}"
                   onchange="updateExportBtn()" aria-label="Select PO {{ po.po_number }}">
          </td>
          <!-- PO Number (links to project) -->
          <td class="py-3 px-3 font-mono">
            {% if po.project_id %}
            <a href="/projects/{{ po.project_id }}" class="text-walmart-blue-100 hover:underline font-medium">
              {{ po.po_number }}
            </a>
            {% else %}
            {{ po.po_number }}
            {% endif %}
          </td>
          <!-- Vendor -->
          <td class="py-3 px-3 max-w-[180px] truncate" title="{{ po.vendor }}">{{ po.vendor }}</td>
          <!-- Store+Seq → opens Lucernex -->
          <td class="py-3 px-3">
            {% if po.project_id %}
            <a href="https://walmart.lucernex.com/en/project/EntityInfo.jsp?inPanel=false&requestedProjectEntityType=CapitalProject&projectEntityID={{ po.project_id }}"
               target="_blank" rel="noopener noreferrer"
               class="text-walmart-blue-100 hover:underline inline-flex items-center gap-1"
               aria-label="Open {{ po.store_sequence }} in Lucernex">
              {{ po.store_sequence or '' }}
              <svg class="w-3 h-3 text-walmart-gray-100" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
              </svg>
            </a>
            {% else %}
            {{ po.store_sequence or '' }}
            {% endif %}
          </td>
          <!-- City -->
          <td class="py-3 px-3">{{ po.city or '' }}</td>
          <!-- State -->
          <td class="py-3 px-3">{{ po.state or '' }}</td>
          <!-- Project Status -->
          <td class="py-3 px-3">
            {% if po.project_status %}
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
              {% if po.project_status == 'Active' %}bg-walmart-green-10 text-walmart-green-100
              {% elif po.project_status == 'Complete' %}bg-walmart-blue-10 text-walmart-blue-100
              {% elif po.project_status == 'On Hold' %}bg-walmart-spark-10 text-walmart-spark-140
              {% else %}bg-walmart-red-10 text-walmart-red-100{% endif %}">
              {{ po.project_status }}
            </span>
            {% endif %}
          </td>
          <!-- PO Status -->
          <td class="py-3 px-3">
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium
              {% if po.po_status == 'Open' %}bg-walmart-green-10 text-walmart-green-100
              {% elif po.po_status == 'Closed' %}bg-walmart-gray-10 text-walmart-gray-160
              {% else %}bg-walmart-spark-10 text-walmart-spark-140{% endif %}">
              {{ po.po_status or 'N/A' }}
            </span>
          </td>
          <!-- PO Total -->
          <td class="py-3 px-3 text-right font-medium cost-data">{{ po.po_total | currency }}</td>
          <!-- Invoiced -->
          <td class="py-3 px-3 text-right cost-data">{{ po.invoiced_to_date | currency }}</td>
          <!-- Remaining -->
          <td class="py-3 px-3 text-right font-medium cost-data
            {% if po.is_over_invoiced %}text-walmart-red-100{% elif po.remaining_to_invoice > 0 %}text-walmart-spark-140{% else %}text-walmart-green-100{% endif %}">
            {{ po.remaining_to_invoice | currency }}
            {% if po.is_over_invoiced %}
            <span class="block text-xs text-walmart-red-100 font-bold">OVER-INVOICED</span>
            {% endif %}
          </td>
          <!-- Give-Back -->
          <td class="py-3 px-3 text-right">
            {% if po.give_back_flag %}
            <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-bold bg-walmart-red-10 text-walmart-red-100 cost-data">
              ⚠ {{ po.give_back_amount | currency }}
            </span>
            {% else %}
            <span class="text-walmart-gray-100">—</span>
            {% endif %}
          </td>
          <!-- Days Aged -->
          <td class="py-3 px-3 text-center">
            {% if po.days_since_last_invoice is not none %}
            <span class="font-medium
              {% if po.days_since_last_invoice >= 60 %}text-walmart-red-100
              {% elif po.days_since_last_invoice >= 30 %}text-walmart-spark-140
              {% else %}text-walmart-gray-160{% endif %}">
              {{ po.days_since_last_invoice }}d
            </span>
            {% else %}
            <span class="text-walmart-gray-100">—</span>
            {% endif %}
          </td>
          <!-- Created -->
          <td class="py-3 px-3 text-sm">{{ po.created_date[:10] if po.created_date else '' }}</td>
          <!-- Actions -->
          <td class="py-3 px-3 text-center">
            <button onclick="openPoModal('{{ po.po_number }}')"
                    class="text-walmart-blue-100 hover:text-walmart-blue-130 text-xs font-medium
                           focus:outline-none focus:ring-2 focus:ring-walmart-blue-100 rounded px-2 py-1"
                    aria-label="Quick view PO {{ po.po_number }}">
              Quick View
            </button>
          </td>
        </tr>
        {% endfor %}
        {% if not pos %}
        <tr>
          <td colspan="14" class="py-12 text-center text-walmart-gray-100">
            No purchase orders found matching your filters.
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if total_pages > 1 %}
  <div class="flex items-center justify-between px-4 py-3 border-t border-walmart-gray-10">
    <button onclick="goToPage({{ page - 1 }})" {% if page <= 1 %}disabled{% endif %}
            class="px-3 py-1.5 rounded-lg text-sm font-medium border border-walmart-gray-50
                   hover:bg-walmart-gray-10 disabled:opacity-40 disabled:cursor-not-allowed"
            aria-label="Previous page">
      ← Prev
    </button>
    <div class="flex gap-1">
      {% for p in range(1, total_pages + 1) %}
      {% if p <= 3 or p > total_pages - 3 or (p >= page - 1 and p <= page + 1) %}
      <button onclick="goToPage({{ p }})"
              class="px-3 py-1.5 rounded-lg text-sm font-medium
                     {% if p == page %}bg-walmart-blue-100 text-white{% else %}hover:bg-walmart-gray-10{% endif %}"
              aria-label="Page {{ p }}" {% if p == page %}aria-current="page"{% endif %}>{{ p }}</button>
      {% elif p == 4 or p == total_pages - 3 %}
      <span class="px-2 py-1.5 text-walmart-gray-100">&hellip;</span>
      {% endif %}
      {% endfor %}
    </div>
    <button onclick="goToPage({{ page + 1 }})" {% if page >= total_pages %}disabled{% endif %}
            class="px-3 py-1.5 rounded-lg text-sm font-medium border border-walmart-gray-50
                   hover:bg-walmart-gray-10 disabled:opacity-40 disabled:cursor-not-allowed"
            aria-label="Next page">
      Next →
    </button>
  </div>
  {% endif %}
</div>
