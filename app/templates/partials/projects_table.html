{% set sort = sort | default('project_id') %}
{% set order = order | default('asc') %}

{% macro sort_header(column, label, align='left') %}
<th class="text-{{ align }} py-2 px-2 font-semibold cursor-pointer select-none hover:bg-walmart-blue-10 transition-colors whitespace-nowrap text-xs"
    scope="col" onclick="sortBy('{{ column }}')" role="columnheader"
    aria-sort="{% if sort == column %}{{ 'ascending' if order == 'asc' else 'descending' }}{% else %}none{% endif %}">
  <span class="inline-flex items-center gap-1 {% if align == 'right' %}justify-end w-full{% endif %}">
    {{ label }}
    {% if sort == column %}
      <span class="text-walmart-blue-100 text-xs">{{ '▲' if order == 'asc' else '▼' }}</span>
    {% else %}
      <span class="text-walmart-gray-50 text-xs">▴▾</span>
    {% endif %}
  </span>
</th>
{% endmacro %}

{% macro banner_badge(banner) %}
{% if banner == "Sam's Club" %}
  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Sam's</span>
{% elif banner == "DC" %}
  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800">DC</span>
{% else %}
  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Walmart</span>
{% endif %}
{% endmacro %}

<table class="w-full text-xs table-fixed" role="table">
  <colgroup>
    <col style="width:7%">  <!-- Entity RecID -->
    <col style="width:6%">  <!-- Banner -->
    <col style="width:7%">  <!-- Type -->
    <col style="width:5%">  <!-- Store -->
    <col style="width:9%"> <!-- Location -->
    <col style="width:14%"> <!-- Scope of Work -->
    <col style="width:9%"> <!-- Status -->
    <col style="width:11%"> <!-- Contractor -->
    <col style="width:7%">  <!-- Created -->
    <col style="width:7%">  <!-- Completed -->
    <col style="width:8%">  <!-- Budget -->
    <col style="width:8%">  <!-- Actuals -->
  </colgroup>
  <thead>
    <tr class="bg-walmart-gray-10 border-b border-walmart-gray-50">
      {{ sort_header('project_id', 'Entity RecID') }}
      {{ sort_header('banner', 'Banner') }}
      {{ sort_header('project_type', 'Type') }}
      {{ sort_header('store', 'Store') }}
      {{ sort_header('location', 'Location') }}
      {{ sort_header('scope', 'Scope of Work') }}
      {{ sort_header('project_status', 'Status') }}
      {{ sort_header('general_contractor', 'Contractor') }}
      {{ sort_header('created_date', 'Created') }}
      {{ sort_header('construction_complete_date', 'Completed') }}
      {{ sort_header('budget_total', 'Budget', 'right') }}
      {{ sort_header('budget_actuals', 'Actuals', 'right') }}
    </tr>
  </thead>
  <tbody>
    {% for p in projects %}
    <tr class="border-b border-walmart-gray-10 hover:bg-walmart-blue-10 transition-colors cursor-pointer"
        onclick="if(!event.target.closest('a')){window.location='/projects/{{ p.project_id }}'}">
      <td class="py-2 px-2">
        <a href="https://walmart.lucernex.com/en/project/EntityInfo.jsp?inPanel=false&requestedProjectEntityType=CapitalProject&projectEntityID={{ p.project_id }}"
           target="_blank" rel="noopener noreferrer"
           class="text-walmart-blue-100 font-medium hover:underline inline-flex items-center gap-1"
           aria-label="Open Entity {{ p.project_id }} in Lucernex">
          {{ p.project_id }}
          <svg class="w-3 h-3 text-walmart-gray-100" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-4M14 4h6m0 0v6m0-6L10 14"/>
          </svg>
        </a>
      </td>
      <td class="py-2 px-2">{{ banner_badge(p.banner) }}</td>
      <td class="py-2 px-2 text-xs">
        <span class="inline-flex items-center px-2 py-0.5 rounded-full font-medium
          {% if 'WATER' in p.project_type %}bg-blue-100 text-blue-800
          {% elif 'GAS' in p.project_type %}bg-orange-100 text-orange-800
          {% elif 'SANITARY' in p.project_type %}bg-yellow-100 text-yellow-800
          {% else %}bg-purple-100 text-purple-800{% endif %}">
          {{ p.project_type.replace('PLBG ', '') }}
        </span>
      </td>
      <td class="py-2 px-2 font-medium">{{ p.store }}</td>
      <td class="py-2 px-2 whitespace-nowrap">{{ p.city }}, {{ p.state }}</td>
      <td class="py-2 px-2 max-w-[10rem] truncate" title="{{ p.brief_scope_of_work }}">{{ p.brief_scope_of_work or '—' }}</td>
      <td class="py-2 px-2">
        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium whitespace-nowrap
          {% if p.project_status == 'Active' %}bg-walmart-green-10 text-walmart-green-100
          {% elif p.project_status == 'Complete' or p.project_status == 'Construction Complete' %}bg-walmart-blue-10 text-walmart-blue-100
          {% elif p.project_status == 'On Hold' or p.project_status == 'Due Diligence' %}bg-walmart-spark-10 text-walmart-spark-140
          {% elif p.project_status == 'Financial Closeout' %}bg-walmart-gray-10 text-walmart-gray-160
          {% elif p.project_status == 'Construction' or p.project_status == 'Design' %}bg-blue-50 text-blue-700
          {% else %}bg-walmart-red-10 text-walmart-red-100{% endif %}">
          {{ p.project_status }}
        </span>
      </td>
      <td class="py-2 px-2 max-w-[8rem] truncate" title="{{ p.general_contractor }}">{{ p.general_contractor or '—' }}</td>
      <td class="py-2 px-2 whitespace-nowrap text-xs">
        {% if p.created_date %}
          {{ p.created_date[:10] }}
        {% else %}
          —
        {% endif %}
      </td>
      <td class="py-2 px-2 whitespace-nowrap text-xs">
        {% if p.construction_complete_date and p.construction_complete_date != '9999-12-31' %}
          {{ p.construction_complete_date }}
        {% else %}
          —
        {% endif %}
      </td>
      <td class="py-2 px-2 text-right whitespace-nowrap">{{ p.budget_total | currency }}</td>
      <td class="py-2 px-2 text-right whitespace-nowrap">{{ p.budget_actuals | currency }}</td>
    </tr>
    {% else %}
    <tr>
      <td colspan="12" class="py-8 text-center text-walmart-gray-100">No projects match your filters.</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
