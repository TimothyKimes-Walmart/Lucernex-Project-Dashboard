{% extends "base.html" %}
{% set active_page = "pos" %}
{% block title %}Purchase Orders{% endblock %}

{% block content %}
<div class="mb-6 flex items-start justify-between">
  <div>
    <h1 class="text-2xl font-bold mb-2">Purchase Orders</h1>
    <p class="text-walmart-gray-100 text-sm">Operational & financial control center for PO monitoring, vendor follow-up, and give-back tracking.</p>
  </div>
  <button type="button" id="refresh-btn" onclick="refreshData()"
          class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium
                 bg-walmart-blue-100 text-white hover:bg-walmart-blue-110 transition-colors
                 focus:outline-none focus:ring-2 focus:ring-walmart-blue-100 focus:ring-offset-2
                 disabled:opacity-50 disabled:cursor-not-allowed"
          aria-label="Refresh data from Lucernex">
    <svg id="refresh-icon" class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
    </svg>
    <span id="refresh-label">Refresh Data</span>
  </button>
</div>

<!-- Data Freshness -->
{% include 'partials/refresh_info.html' %}

<!-- Summary Panel -->
<div id="po-summary" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
  {% include 'partials/pos_summary.html' %}
</div>

<!-- Filters + Search -->
<div class="bg-white rounded-xl shadow-sm border border-walmart-gray-50 p-4 mb-6">
  <form id="po-filters"
        hx-get="/pos/table" hx-target="#po-table-container" hx-swap="innerHTML"
        hx-include="#po-filters" hx-trigger="change, input delay:400ms from:#po-search"
        hx-push-url="false">
    <div class="flex flex-wrap gap-3 items-end">
      <!-- Search -->
      <div class="flex-1 min-w-[200px]">
        <label for="po-search" class="block text-xs font-semibold text-walmart-gray-100 mb-1">Search</label>
        <input type="text" id="po-search" name="search" value="{{ search }}"
               placeholder="PO, vendor, store, scope of work, project type, contractor..."
               class="w-full px-3 py-2 border border-walmart-gray-50 rounded-lg text-sm
                      focus:outline-none focus:ring-2 focus:ring-walmart-blue-100"
               aria-label="Search purchase orders">
      </div>

      <!-- Vendor -->
      <div class="min-w-[160px]">
        <label for="vendor-filter" class="block text-xs font-semibold text-walmart-gray-100 mb-1">Vendor</label>
        <select id="vendor-filter" name="vendor"
                class="w-full px-3 py-2 border border-walmart-gray-50 rounded-lg text-sm bg-white"
                aria-label="Filter by vendor">
          <option value="">All Vendors</option>
          {% for v in filter_opts.vendors %}
          <option value="{{ v }}" {% if selected_vendor == v %}selected{% endif %}>{{ v }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- State -->
      <div class="min-w-[100px]">
        <label for="state-filter" class="block text-xs font-semibold text-walmart-gray-100 mb-1">State</label>
        <select id="state-filter" name="state"
                class="w-full px-3 py-2 border border-walmart-gray-50 rounded-lg text-sm bg-white"
                aria-label="Filter by state">
          <option value="">All</option>
          {% for s in filter_opts.states %}
          <option value="{{ s }}" {% if selected_state == s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Project Status -->
      <div class="min-w-[140px]">
        <label for="proj-status-filter" class="block text-xs font-semibold text-walmart-gray-100 mb-1">Project Status</label>
        <select id="proj-status-filter" name="project_status"
                class="w-full px-3 py-2 border border-walmart-gray-50 rounded-lg text-sm bg-white"
                aria-label="Filter by project status">
          <option value="">All</option>
          {% for s in filter_opts.project_statuses %}
          <option value="{{ s }}" {% if selected_project_status == s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- PO Status -->
      <div class="min-w-[120px]">
        <label for="po-status-filter" class="block text-xs font-semibold text-walmart-gray-100 mb-1">PO Status</label>
        <select id="po-status-filter" name="po_status"
                class="w-full px-3 py-2 border border-walmart-gray-50 rounded-lg text-sm bg-white"
                aria-label="Filter by PO status">
          <option value="">All</option>
          {% for s in filter_opts.po_statuses %}
          <option value="{{ s }}" {% if selected_po_status == s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- Toggle Filters -->
    <div class="flex flex-wrap gap-4 mt-3 pt-3 border-t border-walmart-gray-10">
      <label class="inline-flex items-center gap-2 text-sm cursor-pointer" aria-label="Show only POs with remaining balance">
        <input type="checkbox" name="has_remaining" value="1"
               {% if has_remaining %}checked{% endif %}
               class="rounded border-walmart-gray-50 text-walmart-blue-100 focus:ring-walmart-blue-100">
        <span>Has Remaining</span>
      </label>
      <label class="inline-flex items-center gap-2 text-sm cursor-pointer" aria-label="Show only give-back POs">
        <input type="checkbox" name="give_back_only" value="1"
               {% if give_back_only %}checked{% endif %}
               class="rounded border-walmart-gray-50 text-walmart-red-100 focus:ring-walmart-red-100">
        <span class="text-walmart-red-100 font-medium">Give-Back Only</span>
      </label>
      <label class="inline-flex items-center gap-2 text-sm cursor-pointer" aria-label="Show POs aged 30+ days">
        <input type="checkbox" name="aging_30" value="1"
               {% if aging_30 %}checked{% endif %}
               class="rounded border-walmart-gray-50 text-walmart-spark-140 focus:ring-walmart-spark-100">
        <span class="text-walmart-spark-140 font-medium">Aging 30+ Days</span>
      </label>

      <!-- Export Button -->
      <div class="ml-auto">
        <button type="button" id="export-email-btn"
                onclick="exportSelectedPOs()"
                class="inline-flex items-center gap-1.5 px-4 py-2 rounded-lg text-sm font-medium
                       bg-walmart-blue-100 text-white hover:bg-walmart-blue-110
                       focus:outline-none focus:ring-2 focus:ring-walmart-blue-100 focus:ring-offset-2
                       disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                disabled
                aria-label="Export selected POs to email draft">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
          <span class="export-label">Export Email</span>
        </button>
      </div>
    </div>

    <!-- Hidden sort/order/page inputs -->
    <input type="hidden" name="sort" id="po-sort-input" value="{{ sort }}">
    <input type="hidden" name="order" id="po-order-input" value="{{ order }}">
    <input type="hidden" name="page" id="po-page-input" value="{{ page }}">
  </form>
</div>

<!-- Table Container -->
<div id="po-table-container">
  {% include 'partials/pos_table.html' %}
</div>

<!-- Quick View Modal -->
<div id="po-modal-backdrop" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="closePoModal()"></div>
<div id="po-modal" class="fixed right-0 top-0 h-full w-full max-w-lg bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 overflow-y-auto"
     role="dialog" aria-label="PO detail view">
  <div id="po-modal-content" class="p-6">
    <!-- Loaded via HTMX -->
  </div>
</div>

<!-- Email Draft Modal -->
<div id="email-modal-backdrop" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="closeEmailModal()"></div>
<div id="email-modal" class="fixed inset-x-4 top-8 bottom-8 mx-auto max-w-3xl bg-white rounded-xl shadow-2xl z-50 hidden overflow-y-auto"
     role="dialog" aria-label="Email draft preview">
  <div id="email-modal-content" class="p-6">
    <!-- Loaded via HTMX -->
  </div>
</div>

<script>
  // ── Sort helper ──
  function sortPOs(col) {
    const sortInput = document.getElementById('po-sort-input');
    const orderInput = document.getElementById('po-order-input');
    const pageInput = document.getElementById('po-page-input');
    if (sortInput.value === col) {
      orderInput.value = orderInput.value === 'asc' ? 'desc' : 'asc';
    } else {
      sortInput.value = col;
      orderInput.value = 'asc';
    }
    pageInput.value = '1';
    htmx.trigger('#po-filters', 'change');
  }

  // ── Pagination ──
  function goToPage(p) {
    document.getElementById('po-page-input').value = p;
    htmx.trigger('#po-filters', 'change');
  }

  // ── Checkbox selection ──
  function toggleSelectAll(master) {
    document.querySelectorAll('.po-checkbox').forEach(cb => cb.checked = master.checked);
    updateExportBtn();
  }
  function updateExportBtn() {
    const count = document.querySelectorAll('.po-checkbox:checked').length;
    const btn = document.getElementById('export-email-btn');
    if (!btn) return;
    btn.disabled = count === 0;
    const label = btn.querySelector('.export-label');
    if (label) label.textContent = count > 0 ? `Export Email (${count})` : 'Export Email';
  }

  // ── Quick View Modal ──
  function openPoModal(poNumber) {
    const modal = document.getElementById('po-modal');
    const backdrop = document.getElementById('po-modal-backdrop');
    const content = document.getElementById('po-modal-content');
    content.innerHTML = '<div class="flex items-center justify-center h-32"><span class="text-walmart-gray-100">Loading...</span></div>';
    backdrop.classList.remove('hidden');
    modal.classList.remove('translate-x-full');
    htmx.ajax('GET', '/pos/' + poNumber + '/detail', '#po-modal-content');
  }
  function closePoModal() {
    document.getElementById('po-modal').classList.add('translate-x-full');
    document.getElementById('po-modal-backdrop').classList.add('hidden');
  }

  // ── Email Export ──
  function exportSelectedPOs() {
    const checked = Array.from(document.querySelectorAll('.po-checkbox:checked'));
    if (!checked.length) {
      alert('Please select at least one PO first.');
      return;
    }
    const poNums = checked.map(cb => cb.value).join(',');
    const modal = document.getElementById('email-modal');
    const backdrop = document.getElementById('email-modal-backdrop');
    const content = document.getElementById('email-modal-content');

    // Show modal with loading state
    content.innerHTML = '<div class="flex items-center justify-center h-32"><span class="text-walmart-gray-100 animate-pulse">Generating email drafts...</span></div>';
    modal.classList.remove('hidden');
    backdrop.classList.remove('hidden');

    const formData = new FormData();
    formData.append('po_numbers', poNums);
    fetch('/pos/export-email', { method: 'POST', body: formData })
      .then(function(r) {
        if (!r.ok) throw new Error('Server error: ' + r.status);
        return r.text();
      })
      .then(function(html) {
        content.innerHTML = html;
      })
      .catch(function(err) {
        content.innerHTML = '<p class="text-walmart-red-100 p-4">Failed to generate email drafts: ' + err.message + '</p>';
      });
  }
  function closeEmailModal() {
    document.getElementById('email-modal').classList.add('hidden');
    document.getElementById('email-modal-backdrop').classList.add('hidden');
  }
  function openMailto(subject, body, to) {
    const mailto = 'mailto:' + encodeURIComponent(to || '')
      + '?subject=' + encodeURIComponent(subject)
      + '&body=' + encodeURIComponent(body);
    window.open(mailto, '_blank');
  }

  // ── Data Refresh ──
  function refreshData() {
    const btn = document.getElementById('refresh-btn');
    const icon = document.getElementById('refresh-icon');
    const label = document.getElementById('refresh-label');
    btn.disabled = true;
    icon.classList.add('animate-spin');
    label.textContent = 'Refreshing...';

    fetch('/api/refresh', { method: 'POST' })
      .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
      .then(function(res) {
        if (res.ok) {
          label.textContent = 'Done! Reloading...';
          setTimeout(function() { window.location.reload(); }, 500);
        } else {
          label.textContent = res.data.message || 'Refresh failed';
          setTimeout(function() { label.textContent = 'Refresh Data'; btn.disabled = false; icon.classList.remove('animate-spin'); }, 3000);
        }
      })
      .catch(function(err) {
        label.textContent = 'Error: ' + err.message;
        setTimeout(function() { label.textContent = 'Refresh Data'; btn.disabled = false; icon.classList.remove('animate-spin'); }, 3000);
      });
  }

  // Re-attach listeners after HTMX swap
  document.body.addEventListener('htmx:afterSwap', function(e) {
    if (e.target.id === 'po-table-container') {
      updateExportBtn();
    }
  });
</script>
{% endblock %}
